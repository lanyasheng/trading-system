# MEMORY.md - 交易蜘蛛长期记忆

> 仅在主会话（与用户直接对话）时加载，cron 任务不加载。

## 用户画像

- **投资风格**: 偏价值投资，关注基本面，重视风险控制
- **覆盖市场**: A 股为主，美股作基准对比，港股/大宗商品辅助
- **信息偏好**: 数据驱动，不喜欢空洞预测，要求引用信息来源
- **输出偏好**: 中文，简洁有力，Discord 不用表格用列表
- **持仓关注**: 黄金 ETF（大量持仓）、金风科技、周期股板块

## 自选股概览

详见 `knowledge/watchlist.json`（权威源，95+ 标的）

| 分类 | 数量 | 典型标的 |
|------|------|---------|
| priority（重点） | 9 | 金风科技、中国石油、紫金矿业、黄金ETF、光伏ETF 等 |
| observe（观察） | 12 | 沪深300ETF、航天军工ETF、芯片ETF、电力ETF 等 |
| research（研究） | 3 | 贵州茅台、五粮液、比亚迪 |
| us（美股） | 46 | 七巨头 + 11 板块 ETF + 中概股 + 航天防务 |
| hk（港股） | 6 | 腾讯、阿里、美团、京东、小米、平安 |
| commodity（大宗商品） | 19 | 黄金、白银、原油、铜铝锌镍锡铅、螺纹钢、铁矿石、农产品 |

## 系统配置

- **模型**: 全部任务统一使用 `qwen3.5-plus`
- **数据源**: 腾讯（主）→ 新浪（备）→ 东方财富（三备），同花顺（涨跌停池）
- **工具入口**: `quant.py` CLI wrapper（19 个原子工具）
- **缓存**: SQLite（K 线）+ JSON（日快照）+ 内存（实时情绪）
- **输出**: Discord 自动推送（分段策略，每条 1500-1900 字）
- **知识库**: `knowledge/watchlist.json` + `knowledge/decisions/`

## 经验教训

### 数据源

| 模式 | 经验 |
|------|------|
| ❌ | **龙虎榜 API 字段名与文档不一致**: 东财 API 的买入/卖出金额字段是 `BILLBOARD_BUY_AMT`/`BILLBOARD_SELL_AMT`，不是 `BUY_AMT`/`SELL_AMT`。且不传日期参数会返回全部历史数据(25万+条)，必须先查 1 条获取最近交易日再按日期筛选 |
| ❌ | **关键字猜板块不可靠，必须用 API 获取真实行业**: 用股票名称关键字("金"→贵金属)分类导致金正大(农化)被误归。东财 push2 ulist API 的 f100 字段可批量获取准确行业分类 |
| ✅ | **K 线指数数据源选择**: 腾讯不支持指数 K 线(返回 param error)，东财易断连，新浪(CN_MarketData.getKLineData)稳定支持 sh000300 日 K 线。指数类数据优先用新浪 |
| ✅ | **评分权重必须归一化检查**: scoring.py 4 项显式权重 + 1 项默认权重 = 1.10，导致总分偏高约 10%。应在代码中添加 w_total 归一化逻辑 |
| ✅ | **新增缓存层前必须先了解已有缓存能力**: 已有 SQLite cache.db 缓存个股 K 线，新增 JSON 日志缓存时应复用而非重建 |

### OpenClaw 平台

| 模式 | 经验 |
|------|------|
| ❌ | **cron announce 在 Discord 上会严重丢失内容**: announce 路径将 3500 字精简到 800 字。解决: `delivery.mode="none"` + prompt 中指示 agent 用 `message` 工具直接发送 |
| ❌ | **修改 cron jobs.json 必须先停止 gateway**: gateway 内存中保持配置，改磁盘后不重启会被覆盖。正确: `launchctl kickstart -k` |
| ❌ | **cron prompt 字数限制直接决定输出质量**: "<=300字" 导致只输出涨跌幅，">=1000字" 才能输出完整分析 |
| ❌ | **A 股 cron 非交易时间返回 HEARTBEAT_OK 是正常行为**: 不要在收盘后等待输出来验证变更 |
| ❌ | **timeout 报错≠内容丢失**: cron timeout 只代表 LLM 未干净结束 turn，message 工具已调用则 Discord 已收到内容 |
| ✅ | **exec-based skill 比 MCP plugin 更稳定**: exec 工具调用 CLI wrapper + skill 定义的模式更可靠，token 消耗更低 |

### 架构设计

| 模式 | 经验 |
|------|------|
| ✅ | **"胖工具箱+瘦Skill"优于"多Skill"架构**: 16 个旧 Skill 各自实现数据获取，导致上下文碎片化、代码重复、维护困难。1 Skill + 19 工具 + 共享基础设施解决了所有问题 |
| ❌ | **自动修复脚本对嵌套代码块的 try/except 插入极易破坏缩进**: 复杂嵌套代码应采用顶层 try/except 或手动修复 |

> ✅ = 成功模式 | ❌ = 失败教训

## 重要判断记录

### 2026-02-24 周期股异动事件
**背景**: 多个周期股同步异动（兴业银锡+6.84%、中国石油+4.93%、金风科技+4.74%），消费股资金流出，板块切换明显。
**判断**: 资金从消费→周期轮动，商品价格上涨+能源安全主题驱动。
**后续**: 需跟踪持续性、ETF 溢价、其他周期股联动。
