# 交易蜘蛛 🕷️

> 基于 OpenClaw 构建的 AI 多市场交易监控与分析系统。覆盖 A 股、美股、港股、贵金属、原油及工业金属。

[English](README.md) | **中文**

## 为什么选择交易蜘蛛？

大多数 AI 交易机器人都有两个致命缺陷：追涨杀跌或数据幻觉。交易蜘蛛从架构层面解决了这两个问题：

- **反追涨杀跌评分**: 系统对已经大涨的股票_扣分_而非加分，避免散户经典错误
- **数据优先架构**: 每个数字都来自经过验证的 API 调用——Agent 被明确禁止编造价格或指标
- **多源容灾**: 某个数据源宕机时，自动回退链保证系统持续运行

## 系统架构

### 三层设计

```
┌──────────────────────────────────────────────────────────────────┐
│                     第一层: 编排层                                │
│  OpenClaw Gateway (Node.js) → 定时调度 → Agent 循环              │
│  ┌─────────────┐  ┌──────────────┐  ┌───────────────────────┐   │
│  │ Discord 机器人│  │ Cron 引擎    │  │ LLM Agent (qwen3.5+) │   │
│  │ (推送/交互)   │  │ (12 个任务)   │  │ SOUL.md 规则驱动      │   │
│  └─────────────┘  └──────────────┘  └───────────────────────┘   │
├──────────────────────────────────────────────────────────────────┤
│                     第二层: 分析引擎                              │
│  quant.py CLI → 19 个原子工具 → 共享基础设施                      │
│  ┌─────────────┐  ┌──────────────┐  ┌───────────────────────┐   │
│  │ 评分引擎 V2  │  │ 技术面分析    │  │ 资金流向分析           │   │
│  │ (五维+反追涨) │  │ (MACD/RSI/   │  │ (委比/量比/            │   │
│  │              │  │  KDJ/均线)    │  │  主力资金)             │   │
│  └─────────────┘  └──────────────┘  └───────────────────────┘   │
├──────────────────────────────────────────────────────────────────┤
│                     第三层: 数据采集层                            │
│  8 个数据源 → 回退链 → 熔断器 → 多级缓存                         │
│  ┌──────┐ ┌──────┐ ┌──────────┐ ┌──────┐ ┌────────────────┐    │
│  │ 腾讯  │ │ 新浪  │ │ 东方财富  │ │同花顺 │ │ yfinance (备)  │    │
│  └──┬───┘ └──┬───┘ └────┬─────┘ └──┬──┘ └───────┬────────┘    │
│     └────────┴──────────┴──────────┴─────────────┘              │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │     回退链 + 熔断器 + 频率控制 + User-Agent 轮换           │    │
│  └──────────────────────────────────────────────────────────┘    │
│  ┌──────────────────────────────────────────────────────────┐    │
│  │              三级缓存                                      │    │
│  │  SQLite (90天K线) │ JSON (60天日志) │ 内存 (60s/10min)    │    │
│  └──────────────────────────────────────────────────────────┘    │
└──────────────────────────────────────────────────────────────────┘
```

## 多级回退系统

系统设计为"永不沉默"。当数据源故障时，自动优雅降级：

### 数据源回退链

| 市场 | 主源 | 备源 | 第三备源 | 全挂时 |
|------|------|------|---------|--------|
| A 股 | 腾讯 | 新浪 | 东方财富 | 报告"数据不可用" |
| 美股 | 腾讯美股 | yfinance | — | 使用最近缓存 |
| 港股 | 腾讯港股 | — | — | 报告"数据不可用" |
| 大宗商品 | 新浪商品 | — | — | 报告"数据不可用" |
| 北向资金 | 东方财富 | — | — | 使用日缓存 |
| 涨跌停池 | 同花顺 | — | — | 跳过异动板块 |
| 新闻 | 东财 | 财联社 | 金十+新浪+华尔街 | 部分报告 |

### 熔断器模式

每个数据源有独立的熔断器：

```
正常 ──[连续5次失败]──▶ 熔断开启（暂停60秒）
                              │
                         [60秒后]
                              │
                              ▼
                        半开（探测一次）
                         │           │
                       [成功]      [失败]
                         │           │
                         ▼           ▼
                       正常      熔断开启（重置计时）
```

### 三级缓存策略

| 层级 | 存储 | TTL | 缓存内容 | 设计原因 |
|------|------|-----|---------|---------|
| **L1: 内存** | 进程内字典 | 60s / 10min | 大盘情绪、连涨天数 | 避免高频请求轰炸 API |
| **L2: JSON** | `cache/daily_market_log.json` | 60 天 | 每日沪深300涨跌、北向 | 历史趋势计算 |
| **L3: SQLite** | `stock_data/cache.db` | 每日刷新 | 自选股90天K线 | 技术指标计算输入 |

每日 08:50 盘前自动预热缓存。

## 评分引擎 V2

### 五维度模型

| 维度 | 权重 | 指标 | 边界处理 |
|------|------|------|---------|
| **技术面** | 25% | MACD交叉、RSI(14+6日)、KDJ、均线排列 | K>80时金叉扣分而非加分 |
| **资金面** | 30% | 量比、换手率、委比、量价方向 | 放量下跌 = 出逃信号(-5分) |
| **基本面** | 10% | 分行业PE（15个行业阈值）、PB | 银行PE<8正常、科技PE 20-40正常 |
| **情绪面** | 20% | 5源新闻情绪、大盘情绪指数 | 利空-3分、利多+2分（非对称） |
| **大盘面** | 15% | 沪深300/中证500/上证50/创业板 | 连涨3天-5分、5天-10分 |

### 反追涨杀跌机制（核心差异化）

大多数评分系统奖励动量——股票在涨就加分，导致追高杀跌。交易蜘蛛反其道行之：

| 条件 | 扣分 | 逻辑 |
|------|------|------|
| 涨停 | -12 分 | T+1 制度下无法买入，追高风险极大 |
| 大涨 (≥5%) | -6 分 | 短期超买 |
| RSI > 80 | 信号上限锁定为 WATCH | 超买区不允许买入信号 |
| KDJ K>80 金叉 | -1 代替 +4 | 高位钝化 |
| 放量急拉 | -3 分 | 追高风险信号 |
| 放量暴跌 | -5 分 | 资金出逃信号 |
| 连涨 3 天 | -5 分 | 均值回归压力 |
| 连涨 5 天 | -10 分 | 强均值回归 |
| 北向连续3日流出 | -4 分 | 外资撤退 |
| 北向连续5日流出 | -8 分 | 持续外资抛售 |
| 跌停 | +8 分 | 超跌反弹潜力 |
| 大跌 (≥5%) | +4 分 | 逆向机会 |

### 分行业 PE 阈值

系统不使用统一 PE 标准，而是按行业差异化评分：

| 行业 | 低估 PE | 合理 PE | 高估 PE |
|------|---------|---------|---------|
| 银行 | < 5 | 5-8 | > 10 |
| 房地产 | < 8 | 8-15 | > 20 |
| 科技 | < 20 | 20-40 | > 60 |
| 消费 | < 15 | 15-30 | > 45 |
| 医药 | < 20 | 20-35 | > 50 |
| 公用事业 | < 10 | 10-20 | > 30 |
| ... | （共 15 个行业） | | |

## 19 个分析工具

| # | 工具 | 功能 | 数据源 | 延迟 |
|---|------|------|--------|------|
| 1 | `stock_analysis` | 五维度综合评分 | 腾讯→新浪→东财 | ~3s |
| 2 | `weekly_review` | 周度自选股复盘 | K线缓存+新闻 | ~3s |
| 3 | `us_stock` | 美股行情（17标的） | 腾讯美股→yfinance | ~0.5s |
| 4 | `hk_stock` | 港股行情 | 腾讯港股 | ~0.2s |
| 5 | `commodity` | 19品种大宗商品 | 新浪商品 | ~0.5s |
| 6 | `global_overview` | 一键全市场概览 | 多数据源 | ~1s |
| 7 | `market_anomaly` | 涨跌停池+真实行业标签 | 同花顺+东财 | ~0.4s |
| 8 | `market_scan` | 全A涨跌幅/成交量排行 | 新浪 | ~1s |
| 9 | `top_amount` | 成交额 TOP N | 新浪 | ~0.3s |
| 10 | `capital_flow` | 个股分钟级资金流向 | 同花顺 | ~0.7s |
| 11 | `northbound_flow` | 北向资金实时流入 | 东方财富 | ~0.2s |
| 12 | `news_sentiment` | 5源新闻聚合+情绪评分 | 东财/财联社/金十/新浪/华尔街 | ~1s |
| 13 | `gold_analysis` | 黄金白银深度分析 | 新浪+东财 | ~1s |
| 14 | `margin_data` | 融资融券余额 | 东方财富 | ~0.5s |
| 15 | `lhb` | 龙虎榜（机构动向） | 东方财富 | ~0.5s |
| 16 | `main_flow` | 主力资金净流入 | 东方财富 | ~0.5s |
| 17 | `save_daily` | 每日市场快照缓存 | 东方财富 | ~0.5s |
| 18 | `system_health` | 数据源健康检查 | 内部 | 即时 |
| 19 | `warm_klines` | K线缓存预热 | 腾讯→SQLite | ~30s |

## 定时任务

### 交易日（周一至周五，北京时间）

```
08:50  ┌── K线预热 ──────────────────────────────────────────┐
       │   拉取自选股90天K线数据到SQLite缓存                    │
09:24  ├── 开盘集合竞价监控 ──────────────────────────────────┤
       │   检测盘前资金建仓动向                                │
09:30  ├── 盘中循环（每10分钟）──────────────────────────────┤
       │   自选股快照 + 异动扫描 + 资金流向                     │
14:50  ├── 尾盘集合竞价监控 ──────────────────────────────────┤
       │   检测尾盘资金抢筹行为                                │
15:05  ├── 收盘总结（10步分析）──────────────────────────────┤
       │   完整报告: 评分+龙虎榜+融资融券+情绪+缓存今日快照      │
       └────────────────────────────────────────────────────┘

21:30  ┌── 美股盘中循环（每30分钟）──────────────────────────┐
       │   美股行情 + 大宗商品 + 黄金白银                       │
05:30  ├── 美股收盘总结 ──────────────────────────────────────┤
       │   对次日A股的影响分析                                 │
       └────────────────────────────────────────────────────┘

周六   ┌── 周度复盘 ──────────────────────────────────────────┐
10:00  │   17只自选股完整数据 + 全球宏观 + 板块轮动              │
       └────────────────────────────────────────────────────┘
```

## Agent 设计理念

交易蜘蛛采用**"胖工具箱 + 瘦 Skill"**架构：

- **1 个 Skill**（`trading-quant`）作为统一入口
- **19 个原子工具** 共享同一套数据基础设施
- **SOUL.md** 定义身份、规则、反幻觉约束和工具路由
- **AGENTS.md** 定义会话启动、记忆和输出格式规则

这与多 Skill 架构（每个功能一个独立 Skill）有本质区别，原因是：

1. **上下文保持**: 所有分析在一个对话轮次中完成，不丢失中间结果
2. **代码复用**: 所有工具共享回退链、熔断器、缓存，保证一致性
3. **单点维护**: 修改评分逻辑只需改一个地方

受 [TradingAgents](https://github.com/TauricResearch/TradingAgents) 多视角辩论模式启发，系统在重大决策时推荐多空双视角分析。

## 快速开始

### 环境要求

- Python 3.12+，macOS（已在 M1 Max 上测试）
- [OpenClaw CLI](https://github.com/openclaw) 已安装配置
- Discord 机器人 Token（用于自动推送）
- 中国市场数据 API 访问（腾讯/新浪/东方财富免费接口）

### 安装

```bash
# 1. 克隆
git clone https://github.com/lanyasheng/trading-system.git
cd trading-system

# 2. Python 依赖
cd mcp-server
python3 -m venv .venv && source .venv/bin/activate
pip install httpx pyyaml pandas-ta

# 3. 配置 OpenClaw
openclaw init
# 编辑 ~/.openclaw/openclaw.json 添加模型 API Key 和 Discord Token

# 4. 启动
openclaw gateway install

# 5. 验证
./skills/trading-quant/scripts/quant.py system_health
./skills/trading-quant/scripts/quant.py stock_analysis
```

### 配置

编辑 `mcp-server/config/settings.yaml`：

```yaml
watchlist:
  - {code: "002202", name: "金风科技", market: "A"}
  - {code: "600519", name: "贵州茅台", market: "A"}

scoring:
  weights:
    technical: 0.25
    capital: 0.30
    fundamental: 0.10
    sentiment: 0.20
    market: 0.15
  thresholds:
    strong_buy: 78
    buy: 63
    sell: 22
    strong_sell: 18
```

## 路线图

- [ ] **回测系统**: 记录预测 → 对比 T+1/3/5 实际结果 → 准确率统计 → 自动调参
- [ ] **组合跟踪**: 虚拟持仓 → 对比沪深300基准 → 最大回撤 / 夏普比率
- [ ] **报告归档**: 按日期存储日报和周报，支持趋势分析
- [ ] **代码收敛**: 统一 quant.py 和 server.py 为单一入口
- [ ] **X/推特监控**: 追踪关键人物（政策制定者、行业领袖）
- [ ] **数据质量 SLI/SLO**: 数据源可用性 P95、延迟监控、降级告警
- [ ] **多模型 A/B**: 对比不同 LLM 的评分准确度
- [ ] **多空辩论模式**: 重大决策时的多 Agent 视角分析

## 免责声明

本系统**仅供研究和学习使用**，不构成任何投资建议。交易存在重大损失风险。过去的表现不保证未来结果。请在做出投资决策前进行独立研究。

## 许可证

MIT
